<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des Badges | Blog Pigier</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="shortcut icon" href="../img/logo.png" />
    <style>
      .badge-preview {
        padding: 5px 10px;
        border-radius: 15px;
        display: inline-block;
        font-size: 0.875rem;
      }
      .user-badge {
        margin: 0 3px;
        font-size: 0.8rem;
        color: #000;
      }
      .user-badge.light-text {
        color: #fff;
      }
      .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.2rem;
        margin: 0 0.2rem;
        background: transparent;
      }
      .btn-edit {
        color: #000;
        border: 1px solid #ffc107;
        background-color: #ffc107;
      }
      .btn-edit:hover {
        background-color: #ffca2c;
        color: #000;
      }
      .btn-delete {
        color: #fff;
        border: 1px solid #dc3545;
        background-color: #dc3545;
      }
      .btn-delete:hover {
        background-color: #bb2d3b;
        color: #fff;
      }
      .btn-action i {
        color: inherit;
      }
      .header .btn-primary {
        background-color: #020268;
        border-color: #020268;
      }
      .header .btn-primary:hover {
        background-color: #010144;
        border-color: #010144;
      }
      .header .btn-primary i {
        color: #fff;
      }
      .modal-backdrop {
        z-index: 1040;
      }
      .modal {
        z-index: 1050;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <div class="header">
          <h1><i class="fas fa-award me-2"></i>Gestion des Badges</h1>
          <div class="header-actions">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addBadgeModal"
            >
              <i class="fas fa-plus"></i>
              Nouveau Badge
            </button>
          </div>
        </div>

        <!-- Badges List -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Liste des Badges</h2>
              </div>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Badge</th>
                      <th>Couleur</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <span
                          class="badge-preview"
                          style="background-color: #020268"
                        >
                          Badge Test
                        </span>
                      </td>
                      <td>#020268</td>
                      <td>
                        <div class="d-flex gap-2">
                          <button
                            type="button"
                            class="btn btn-action btn-edit"
                            data-bs-toggle="modal"
                            data-bs-target="#editBadgeModal"
                            data-badge-id="1"
                            data-badge-name="Badge Test"
                            data-badge-color="#020268"
                          >
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-action btn-delete">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Users with Badges -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Attribution des Badges</h2>
              </div>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Utilisateur</th>
                      <th>Articles</th>
                      <th>Badges</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <img
                            src="../img/default-avatar.png"
                            alt="Avatar"
                            class="rounded-circle me-2"
                            style="width: 32px; height: 32px"
                          />
                          Utilisateur Test
                        </div>
                      </td>
                      <td>5</td>
                      <td>
                        <span
                          class="badge user-badge"
                          style="background-color: #020268"
                        >
                          Badge Test
                        </span>
                      </td>
                      <td>
                        <button
                          class="btn btn-action btn-edit"
                          data-bs-toggle="modal"
                          data-bs-target="#assignBadgeModal"
                          data-user-id="1"
                          data-username="Utilisateur Test"
                        >
                          <i class="fas fa-plus-circle"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Badge Modal -->
    <div class="modal fade" id="addBadgeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Ajouter un Badge</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form action="add_badge.php" method="POST">
            <div class="modal-body">
              <div class="mb-3">
                <label for="badgeName" class="form-label">Nom du Badge</label>
                <input
                  type="text"
                  class="form-control"
                  id="badgeName"
                  name="name"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="badgeColor" class="form-label">Couleur</label>
                <input
                  type="color"
                  class="form-control form-control-color w-100"
                  id="badgeColor"
                  name="color"
                  value="#020268"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Aperçu</label>
                <div>
                  <span
                    class="badge"
                    id="badgePreview"
                    style="background-color: #020268"
                  >
                    Aperçu du badge
                  </span>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Annuler
              </button>
              <button type="submit" class="btn btn-primary">Ajouter</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Badge Modal -->
    <div
      class="modal fade"
      id="editBadgeModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Modifier le Badge</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form action="edit_badge.php" method="POST">
            <input type="hidden" name="badge_id" id="editBadgeId" />
            <div class="modal-body">
              <div class="mb-3">
                <label for="editBadgeName" class="form-label"
                  >Nom du Badge</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="editBadgeName"
                  name="name"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editBadgeColor" class="form-label">Couleur</label>
                <input
                  type="color"
                  class="form-control form-control-color w-100"
                  id="editBadgeColor"
                  name="color"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Aperçu</label>
                <div>
                  <span class="badge" id="editBadgePreview">
                    Aperçu du badge
                  </span>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Annuler
              </button>
              <button type="submit" class="btn btn-primary">Enregistrer</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Assign Badge Modal -->
    <div
      class="modal fade"
      id="assignBadgeModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Attribuer un Badge</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form action="assign_badge.php" method="POST">
            <input type="hidden" name="user_id" id="assignUserId" />
            <div class="modal-body">
              <p>Attribuer un badge à <strong id="assignUsername"></strong></p>
              <div class="mb-3">
                <label for="badgeSelect" class="form-label"
                  >Sélectionner un Badge</label
                >
                <select
                  class="form-select"
                  id="badgeSelect"
                  name="badge_id"
                  required
                >
                  <option value="1">Badge Test</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Annuler
              </button>
              <button type="submit" class="btn btn-primary">Attribuer</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      $(document).ready(function () {
        // Fonction pour déterminer si une couleur est claire
        function isLightColor(color) {
          const hex = color.replace("#", "");
          const r = parseInt(hex.substr(0, 2), 16);
          const g = parseInt(hex.substr(2, 2), 16);
          const b = parseInt(hex.substr(4, 2), 16);
          const brightness = (r * 299 + g * 587 + b * 114) / 1000;
          return brightness > 128;
        }

        // Fonction utilitaire pour mettre à jour l'aperçu
        function updatePreview(color, text, previewElement) {
          previewElement.css("background-color", color);
          previewElement.css("color", isLightColor(color) ? "#000" : "#fff");
          previewElement.text(text || "Aperçu du badge");
        }

        // Modal d'ajout de badge
        $("#addBadgeModal").on("show.bs.modal", function () {
          updatePreview(
            $("#badgeColor").val(),
            $("#badgeName").val(),
            $("#badgePreview")
          );
        });

        $("#badgeColor").on("input", function () {
          updatePreview(
            $(this).val(),
            $("#badgeName").val(),
            $("#badgePreview")
          );
        });

        $("#badgeName").on("input", function () {
          updatePreview(
            $("#badgeColor").val(),
            $(this).val(),
            $("#badgePreview")
          );
        });

        // Modal d'édition de badge
        $('.btn-edit[data-bs-target="#editBadgeModal"]').on(
          "click",
          function () {
            const badgeId = $(this).data("badge-id");
            const badgeName = $(this).data("badge-name");
            const badgeColor = $(this).data("badge-color");

            $("#editBadgeId").val(badgeId);
            $("#editBadgeName").val(badgeName);
            $("#editBadgeColor").val(badgeColor);

            updatePreview(badgeColor, badgeName, $("#editBadgePreview"));
          }
        );

        $("#editBadgeColor").on("input", function () {
          updatePreview(
            $(this).val(),
            $("#editBadgeName").val(),
            $("#editBadgePreview")
          );
        });

        $("#editBadgeName").on("input", function () {
          updatePreview(
            $("#editBadgeColor").val(),
            $(this).val(),
            $("#editBadgePreview")
          );
        });

        // Modal d'attribution de badge
        $('.btn-edit[data-bs-target="#assignBadgeModal"]').on(
          "click",
          function () {
            const userId = $(this).data("user-id");
            const username = $(this).data("username");

            $("#assignUserId").val(userId);
            $("#assignUsername").text(username);
          }
        );

        // Appliquer les couleurs de texte appropriées pour les badges existants
        $(".user-badge").each(function () {
          const backgroundColor = $(this).css("background-color");
          if (backgroundColor) {
            const rgb = backgroundColor.match(/\d+/g);
            if (rgb) {
              const brightness =
                (parseInt(rgb[0]) * 299 +
                  parseInt(rgb[1]) * 587 +
                  parseInt(rgb[2]) * 114) /
                1000;
              $(this).css("color", brightness > 128 ? "#000" : "#fff");
            }
          }
        });
      });
    </script>
  </body>
</html>
